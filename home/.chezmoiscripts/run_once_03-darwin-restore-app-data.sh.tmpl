{{ $roles := list -}}
{{ if hasKey .hosts .chezmoi.hostname -}}
{{ $hostConfig := index .hosts .chezmoi.hostname -}}
{{ $roles = $hostConfig.roles -}}
{{ end -}}
{{ if and (eq .chezmoi.os "darwin") (has "eurosport" $roles) -}}
#!/bin/bash

set -euo pipefail

TMPDIR="$(mktemp -d)"
trap 'rm -rf "$TMPDIR"' EXIT

# --- MongoDB Compass ---
COMPASS_APP="/Applications/MongoDB Compass.app/Contents/MacOS/MongoDB Compass"

if [ ! -f "$COMPASS_APP" ]; then
  echo "MongoDB Compass is not installed, skipping connections import."
else
  echo "Importing connections into MongoDB Compass..."
  COMPASS_FILE="$TMPDIR/compass-connections.json"
  cat > "$COMPASS_FILE" <<'COMPASS_EOF'
{{ onepasswordDocument "MongoDB Compass Connections" "Eurosport" -}}
COMPASS_EOF
  "$COMPASS_APP" --import-connections="$COMPASS_FILE"
  echo "MongoDB Compass connections imported successfully."
fi

# --- TablePlus ---
TABLEPLUS_DATA_DIR="$HOME/Library/Application Support/com.tinyapp.TablePlus-setapp/Data"

if [ -d "$TABLEPLUS_DATA_DIR" ]; then
  echo "TablePlus data directory already exists, skipping restore."
else
  echo "Restoring TablePlus data..."
  TABLEPLUS_FILE="$TMPDIR/tableplus-backup.zip"
  base64 -d -o "$TABLEPLUS_FILE" <<'TABLEPLUS_EOF'
{{ onepasswordDocument "TablePlus Backup" "Eurosport" | b64enc -}}
TABLEPLUS_EOF
  unzip -o "$TABLEPLUS_FILE" -d /
  echo "TablePlus data restored successfully."
fi
{{ end -}}
