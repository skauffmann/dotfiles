#!/usr/bin/env zsh

kill-port () {
  lsof -ti ":${1:-4000}" | xargs kill -9
}

killport () {
  lsof -ti ":${1:-4000}" | xargs kill -9
}

flushdns () {
  sudo killall -HUP mDNSResponder
}

clearmodules () {
  rm -Rf ./node_modules ./**/node_modules/ ./**/build/ ./**/dist/
}

ungit () {
	rm -Rf ./.git ./**/.git
}

uuid () {
 uuidgen | tr 'A-Z' 'a-z' | tr -d '\n'
}

# `o` with no arguments opens the current directory, otherwise opens the given
# location
function o() {
	if [ $# -eq 0 ]; then
		open .;
	else
		open "$@";
	fi;
}

# `tre` is a shorthand for `tree` with hidden files and color enabled, ignoring
# the `.git` directory, listing directories first. The output gets piped into
# `less` with options to preserve color and line numbers, unless the output is
# small enough for one screen.
function tre() {
	tree -aC -I '.git|node_modules|bower_components' --dirsfirst "$@" | less -FRNX;
}

function make () {
  dir=$(pwd)
  while [[ "$dir" != "" && ! -e "$dir/Makefile" ]]; do
    dir=${dir%/*}
  done
  /usr/bin/make -C "$dir" $1
}

function docker-clear {
  docker system prune -a --volumes
}

function backup-apps {
  local tmpdir
  tmpdir="$(mktemp -d)"
  trap 'rm -rf "$tmpdir"' EXIT

  # MongoDB Compass
  local compass_file="$HOME/.mongodb/compass/Connections"
  if [ -f "$compass_file" ]; then
    echo "Backing up MongoDB Compass connections..."
    cp "$compass_file" "$tmpdir/compass-connections.json"
    op document edit "MongoDB Compass Connections" "$tmpdir/compass-connections.json" --vault "Eurosport" 2>/dev/null \
      || op document create "$tmpdir/compass-connections.json" --title "MongoDB Compass Connections" --vault "Eurosport"
    echo "MongoDB Compass connections backed up."
  else
    echo "MongoDB Compass connections file not found, skipping."
  fi

  # TablePlus
  local tableplus_dir="$HOME/Library/Application Support/com.tinyapp.TablePlus-setapp/Data"
  if [ -d "$tableplus_dir" ]; then
    echo "Backing up TablePlus data..."
    (cd / && zip -r "$tmpdir/tableplus-backup.zip" "$tableplus_dir")
    op document edit "TablePlus Backup" "$tmpdir/tableplus-backup.zip" --vault "Eurosport" 2>/dev/null \
      || op document create "$tmpdir/tableplus-backup.zip" --title "TablePlus Backup" --vault "Eurosport"
    echo "TablePlus data backed up."
  else
    echo "TablePlus data directory not found, skipping."
  fi

  echo "All backups complete."
}
